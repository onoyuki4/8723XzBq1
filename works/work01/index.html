    const imageLinks = document.querySelectorAll('.images a');
    const fullscreenContainer = document.getElementById('fullscreen-container');
    const bodyElement = document.body;

    let currentIndex = 0;
    let isFullscreen = false;
    let fullscreenViewer = null;
    let viewerImage = null;
    let counterContainer = null;
    let counterElement = null;
    let pageJumpOverlay = null;

    // 스와이프 & 클릭 관련 변수
    let isDragging = false;
    let startX = 0;
    let currentX = 0;
    let clickStartX = 0; // 드래그 시작 시점 X (클릭 판정용)
    let clickStartY = 0; // 드래그 시작 시점 Y (클릭 판정용)
    let dragStartTime = 0;
    let pointerDown = false;
    const swipeThreshold = 50;  // 스와이프로 인정할 최소 X 이동 거리
    const clickMoveThreshold = 10; // 클릭으로 인정할 최대 이동 거리 (X, Y)
    const clickTimeThreshold = 250;// 클릭으로 인정할 최대 시간 (ms)
    const dragStartThreshold = 5; // 드래그 시작으로 인정할 최소 이동 거리

    function updateCounter() {
      if (counterElement) {
        counterElement.innerText = `${currentIndex + 1} / ${imageLinks.length}`;
      }
    }

    function showImage(index) {
        if (!isFullscreen) return;
        if (index >= 0 && index < imageLinks.length) {
            currentIndex = index;
            const imageUrl = imageLinks.item(currentIndex).getAttribute('href');
            if (viewerImage) {
                viewerImage.style.transition = 'none';
                viewerImage.style.transform = '';
                viewerImage.src = imageUrl;
                updateCounter();
                setTimeout(() => { if(viewerImage) viewerImage.style.transition = ''; }, 50);
            }
        } else {
            console.warn(`Invalid index: ${index}`);
        }
    }

    // --- 페이지 점프 UI (세로 스크롤 목록) ---

    function togglePageJumpUI() { /* 이전과 동일 */
        if (!isFullscreen) return;
        if (pageJumpOverlay) { removePageJumpUI(); return; }
        pageJumpOverlay = document.createElement('div');
        pageJumpOverlay.className = 'page-jump-overlay';
        pageJumpOverlay.addEventListener('click', handleOverlayClick);
        createPageJumpList(pageJumpOverlay);
        fullscreenContainer.appendChild(pageJumpOverlay);
        fullscreenContainer.classList.add('jump-ui-active');
        const currentButton = pageJumpOverlay.querySelector(`.page-jump-number.current`);
        if (currentButton) {
            currentButton.scrollIntoView({ behavior: 'auto', block: 'center' });
        }
    }
    function handleOverlayClick(event) { /* 이전과 동일 */
        if (event.target === pageJumpOverlay) removePageJumpUI();
    }
    function createPageJumpList(overlay) { /* 이전과 동일 */
        const listContainer = document.createElement('div');
        listContainer.id = 'page-jump-list';
        listContainer.addEventListener('click', (e) => e.stopPropagation());
        for (let i = 1; i <= imageLinks.length; i++) {
            const pageNumElement = document.createElement('div');
            pageNumElement.className = 'page-jump-number';
            pageNumElement.innerHTML = `<span>${i}</span>`;
            pageNumElement.dataset.page = i;
            if (i === currentIndex + 1) pageNumElement.classList.add('current');
            pageNumElement.addEventListener('click', handleJumpNumberClick);
            listContainer.appendChild(pageNumElement);
        }
        overlay.appendChild(listContainer);
    }
    function handleJumpNumberClick(event) { /* 이전과 동일 */
        const targetPage = parseInt(event.currentTarget.dataset.page, 10);
        showImage(targetPage - 1);
        removePageJumpUI();
    }
    function removePageJumpUI() { /* 이전과 동일 */
        if (pageJumpOverlay) { pageJumpOverlay.remove(); pageJumpOverlay = null; }
        fullscreenContainer.classList.remove('jump-ui-active');
    }

    // --- 스와이프 & 클릭 이벤트 핸들러 ---

    function handlePointerDown(event) {
        if (pageJumpOverlay || !viewerImage || pointerDown) return;
        if (event.button && event.button !== 0) return;

        pointerDown = true;
        isDragging = false; // 초기엔 드래그 아님
        dragStartTime = Date.now();
        const touch = event.type.startsWith('touch');
        startX = touch ? event.touches[0].clientX : event.clientX;
        currentX = startX;
        clickStartX = startX; // 클릭 판정용 시작점 기록
        clickStartY = touch ? event.touches[0].clientY : event.clientY;

        document.addEventListener('mousemove', handlePointerMove);
        document.addEventListener('touchmove', handlePointerMove, { passive: false });
        document.addEventListener('mouseup', handlePointerUp);
        document.addEventListener('touchend', handlePointerUp);
        document.addEventListener('mouseleave', handlePointerUp);
    }

    function handlePointerMove(event) {
        if (!pointerDown) return;

        const currentMoveX = event.type.startsWith('touch') ? event.touches[0].clientX : event.clientX;
        const currentMoveY = event.type.startsWith('touch') ? event.touches[0].clientY : event.clientY; // Y좌표도 필요

        // 드래그 시작 판정 (최초 move 시, 일정 거리 이상 움직였을 때)
        if (!isDragging) {
            const moveX = Math.abs(currentMoveX - clickStartX);
            const moveY = Math.abs(currentMoveY - clickStartY);
            if (moveX > dragStartThreshold || moveY > dragStartThreshold) {
                isDragging = true; // 이제 확실히 드래그 시작
                if (viewerImage) {
                    viewerImage.classList.add('dragging');
                    viewerImage.style.transition = 'none';
                }
            }
        }

        // isDragging이 true일 때만 이미지 이동
        if (isDragging && viewerImage) {
            currentX = currentMoveX;
            const diffX = currentX - startX;
            viewerImage.style.transform = `translateX(${diffX}px)`;
        }
    }

    function handlePointerUp(event) {
        if (!pointerDown) return;

        pointerDown = false;
        document.removeEventListener('mousemove', handlePointerMove);
        document.removeEventListener('touchmove', handlePointerMove);
        document.removeEventListener('mouseup', handlePointerUp);
        document.removeEventListener('touchend', handlePointerUp);
        document.removeEventListener('mouseleave', handlePointerUp);

        if (!viewerImage) { isDragging = false; return; } // 뷰어 없으면 종료

        viewerImage.classList.remove('dragging');
        viewerImage.style.transition = '';

        const diffX = currentX - startX; // 최종 X 이동 거리
        const dragDuration = Date.now() - dragStartTime;

        // 최종 좌표 (클릭 판정용)
        const touch = event.type === 'touchend';
        // touchend의 경우 changedTouches 사용, mouseup은 clientX/Y 사용
        const endX = touch ? (event.changedTouches[0] ? event.changedTouches[0].clientX : clickStartX) : event.clientX;
        const endY = touch ? (event.changedTouches[0] ? event.changedTouches[0].clientY : clickStartY) : event.clientY;
        const totalMoveX = Math.abs(endX - clickStartX); // 총 이동 거리 X
        const totalMoveY = Math.abs(endY - clickStartY); // 총 이동 거리 Y

        let actionTaken = false;

        // 1. 스와이프 판정: isDragging이 true였고, X 이동 거리가 임계값 이상
        if (isDragging && Math.abs(diffX) >= swipeThreshold) {
            // console.log("Action: Swipe", diffX);
            if (diffX > 0) { prevImage(); } else { nextImage(); }
            actionTaken = true;
        }
        // 2. 클릭 판정: 스와이프가 아니었고, 총 이동 거리와 시간이 임계값 이내
        //    (isDragging이 false였거나, true였어도 스와이프 기준 미달 + 클릭 기준 충족)
        else if (!actionTaken && totalMoveX < clickMoveThreshold && totalMoveY < clickMoveThreshold && dragDuration < clickTimeThreshold) {
            // console.log("Action: Click");
            nextImage(); // 클릭 시 다음 이미지
            actionTaken = true;
            if (viewerImage) viewerImage.style.transform = ''; // 이미지 원위치
        }

        // 3. 그 외 (액션 없었으면 이미지 원위치)
        if (!actionTaken && viewerImage) {
            // console.log("Action: Reset Position Only");
            viewerImage.style.transform = '';
        }

        isDragging = false; // 상태 초기화
    }


    // --- 전체 화면 뷰어 ---

    function openFullscreen(index) { /* 이전과 동일 */
      if (isFullscreen) return;
      currentIndex = index;
      isFullscreen = true;
      const imageUrl = imageLinks.item(currentIndex).getAttribute('href');
      bodyElement.classList.add('fullscreen-active');
      fullscreenViewer = document.createElement('div');
      fullscreenViewer.classList.add('fullscreen-viewer');
      fullscreenViewer.innerHTML = `<img src="${imageUrl}" alt="Image ${currentIndex + 1}">`;
      viewerImage = fullscreenViewer.querySelector('img');
      fullscreenViewer.addEventListener('click', handleViewerClick);
      viewerImage.addEventListener('mousedown', handlePointerDown);
      viewerImage.addEventListener('touchstart', handlePointerDown, { passive: false });
      counterContainer = document.createElement('div');
      counterContainer.className = 'counter-container';
      counterElement = document.createElement("div");
      counterElement.className = "fancybox__counter";
      counterElement.addEventListener('click', togglePageJumpUI);
      counterContainer.appendChild(counterElement);
      fullscreenContainer.appendChild(fullscreenViewer);
      fullscreenContainer.appendChild(counterContainer);
      updateCounter();
      document.addEventListener('keydown', handleKeydown);
      requestAnimationFrame(() => fullscreenViewer.classList.add('active'));
    }

    function handleViewerClick(event) { /* 이전과 동일 */
        if (!pageJumpOverlay && !isDragging && event.target === fullscreenViewer) {
             closeFullscreen();
        }
    }

    function closeFullscreen() { /* 이전과 동일, 리스너 제거 확인 */
      if (!isFullscreen) return;
      isFullscreen = false;
      removePageJumpUI();
      bodyElement.classList.remove('fullscreen-active');

      // 리스너 제거
      if (viewerImage) {
          viewerImage.removeEventListener('mousedown', handlePointerDown);
          viewerImage.removeEventListener('touchstart', handlePointerDown);
      }
      // document 리스너는 handlePointerUp에서 제거되므로 여기서 또 제거할 필요 없음
      if (fullscreenViewer) fullscreenViewer.removeEventListener('click', handleViewerClick);
      if (counterElement) counterElement.removeEventListener('click', togglePageJumpUI);
      document.removeEventListener('keydown', handleKeydown);

      if (fullscreenViewer) fullscreenViewer.classList.remove('active');

      setTimeout(() => {
          fullscreenContainer.innerHTML = '';
          fullscreenViewer = null; viewerImage = null; counterContainer = null;
          counterElement = null; pageJumpOverlay = null;
          isDragging = false; pointerDown = false;
      }, 300);
    }

    function nextImage() { /* 이전과 동일 */
      if (isFullscreen && !pageJumpOverlay) {
        // console.log("Next Image Called - Index:", currentIndex);
        showImage((currentIndex + 1) % imageLinks.length);
      }
    }
    function prevImage() { /* 이전과 동일 */
        if (isFullscreen && !pageJumpOverlay) {
            // console.log("Prev Image Called - Index:", currentIndex);
            showImage((currentIndex - 1 + imageLinks.length) % imageLinks.length);
        }
    }

    function handleKeydown(event) { /* 이전과 동일 */
        if (pageJumpOverlay) {
            if (event.key === 'Escape') removePageJumpUI();
            return;
        }
        if (isFullscreen) {
            if (event.key === 'Escape') closeFullscreen();
            else if (event.key === 'ArrowRight' || event.key === ' ') nextImage();
            else if (event.key === 'ArrowLeft') prevImage();
        }
    }

    // --- 초기화 ---
    imageLinks.forEach(link => { /* 이전과 동일 */
      link.addEventListener('click', function(event) {
        event.preventDefault();
        openFullscreen(parseInt(this.getAttribute('data-index'), 10));
      });
    });
